<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faizan-E-Madinah Admin</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;500;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-dark: #0f1316;
            --gold-primary: #d4af37;
            --gold-light: #f3e5ab;
            --gold-dark: #aa8c2c;
            --text-white: #ffffff;
            --text-muted: #8b9bb4;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow-soft: 0 20px 50px rgba(0, 0, 0, 0.6);
            --font-main: 'Montserrat', sans-serif;
            --font-arabic: 'Amiri', serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            background: linear-gradient(145deg, #0f1316 0%, #080a0c 100%);
            color: var(--text-white);
            font-family: var(--font-main);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-container {
            width: 800px;
            max-width: 95%;
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.9) 0%, rgba(10, 10, 10, 0.95) 100%);
            border: 1px solid var(--gold-primary);
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 90vh;
        }

        .admin-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
        }

        .admin-header h2 {
            margin: 0;
            color: var(--gold-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-white);
            font-family: var(--font-main);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold-primary);
        }

        /* Fix for select dropdowns having white background with white text on some browsers */
        select.form-control option {
            background-color: var(--bg-dark);
            color: var(--text-white);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-main);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gold-primary);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--gold-primary);
            border-bottom-color: var(--gold-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Slide List */
        .slide-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .slide-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            gap: 15px;
        }

        .slide-thumb {
            width: 80px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .slide-url {
            flex: 1;
            font-size: 0.9rem;
            color: #ddd;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .slide-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gold-primary);
        }

        .hidden-slide {
            opacity: 0.5;
        }

        /* Built-in slide icon thumbnail */
        .builtin-slide-thumb {
            width: 80px;
            height: 50px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            flex-shrink: 0;
        }

        .builtin-badge {
            display: inline-block;
            font-size: 0.68rem;
            padding: 2px 7px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            color: var(--text-muted);
            margin-left: 6px;
            vertical-align: middle;
            letter-spacing: 0.03em;
        }

        /* Theme Grid */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .theme-card,
        .layout-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .theme-card:hover,
        .layout-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .theme-card.selected,
        .layout-card.selected {
            border-color: var(--gold-primary);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        .theme-card.selected::after,
        .layout-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gold-primary);
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .theme-preview {
            height: 50px;
            border-radius: 6px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .theme-preview-bar {
            position: absolute;
            left: 0;
            right: 0;
            height: 100%;
        }

        .theme-name {
            font-size: 0.9rem;
            text-align: center;
        }

        /* Custom color picker card */
        .custom-color-card {
            position: relative;
        }

        .custom-color-picker-row {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .custom-color-picker-row.visible {
            display: flex;
        }

        .color-swatch-preview {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            width: 44px;
            height: 44px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
            border-radius: 8px;
            flex-shrink: 0;
        }

        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border-radius: 6px; border: 2px solid rgba(255,255,255,0.15); }

        .layout-preview {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .layout-preview svg {
            width: 100%;
            height: 100%;
        }

        /* Login */
        .login-wrap {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            padding-top: 40px;
        }

        .login-icon {
            font-size: 3rem;
            color: var(--gold-primary);
            margin-bottom: 20px;
        }

        /* --- WEEK TABS --- */
        .week-tabs {
            display: flex;
            gap: 5px;
            margin: 10px 0 15px;
            flex-wrap: wrap;
        }

        .week-tab-btn {
            flex: 1;
            min-width: 80px;
            padding: 9px 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-muted);
            font-family: var(--font-main);
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .week-tab-btn.active {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--gold-primary);
            color: var(--gold-primary);
        }

        .week-tab-btn small {
            font-size: 0.68rem;
            opacity: 0.75;
        }

        .week-tab-btn.current-week {
            position: relative;
        }

        .week-tab-btn.current-week::after {
            content: '\25CF';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 7px;
            color: #4ade80;
        }

        .week-content {
            display: none;
        }

        .week-content.active {
            display: block;
        }

        /* --- PRAYER TIMETABLE --- */
        .timetable-wrap {
            overflow-x: auto;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-height: 340px;
            overflow-y: auto;
        }

        .timetable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
        }

        .timetable th {
            background: rgba(212, 175, 55, 0.12);
            color: var(--gold-primary);
            padding: 8px 10px;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .timetable th:first-child { text-align: left; }

        .timetable td {
            padding: 6px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            text-align: center;
            color: #ccc;
            white-space: nowrap;
        }

        .timetable td:first-child { text-align: left; color: #fff; }

        .timetable tr:hover td { background: rgba(255, 255, 255, 0.03); }

        .timetable .week-badge {
            display: inline-block;
            background: rgba(212, 175, 55, 0.15);
            color: var(--gold-primary);
            border-radius: 4px;
            padding: 1px 5px;
            font-size: 0.68rem;
        }

        .timetable tr.today-row td {
            background: rgba(212, 175, 55, 0.08);
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="admin-container">

        <!-- HEADER -->
        <div class="admin-header">
            <h2><i class="fas fa-cog"></i> Display Settings</h2>
            <div id="auth-controls" style="display:none;">
                <span id="user-email" style="font-size: 0.9rem; margin-right: 15px; color: var(--text-muted);"></span>
                <button class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.9rem;"
                    onclick="logout()">Logout</button>
            </div>
            <a href="index.html" class="btn btn-secondary" target="_blank"
                style="padding: 8px 15px; font-size: 0.9rem; text-decoration: none;">
                <i class="fas fa-external-link-alt"></i> Open Display
            </a>
        </div>

        <!-- BODY -->
        <div class="admin-body">

            <!-- LOGIN VIEW -->
            <div id="login-view">
                <div class="login-wrap">
                    <div class="login-icon"><i class="fas fa-lock"></i></div>
                    <h3>Secure Login</h3>
                    <div class="form-group">
                        <input type="email" id="admin-email" class="form-control" placeholder="Email Address">
                    </div>
                    <div class="form-group">
                        <input type="password" id="admin-password" class="form-control" placeholder="Password">
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="loginAdmin()">Login</button>
                    <p id="login-error" style="color: #ff6b6b; margin-top: 15px; display: none;"></p>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="settings-view" style="display:none;">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('timings')">Timings</button>
                    <button class="tab-btn" onclick="switchTab('slides')">Slides</button>
                    <button class="tab-btn" onclick="switchTab('appearance')">Appearance</button>
                    <button class="tab-btn" onclick="switchTab('api')">API Settings</button>
                </div>

                <!-- 1. TIMINGS -->
                <div id="tab-timings" class="tab-content active">
                    <div class="form-group">
                        <label>Speech Time (HH:MM - 24h format)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="input-speech-h" class="form-control" min="0" max="23"
                                placeholder="HH">
                            <input type="number" id="input-speech-m" class="form-control" min="0" max="59"
                                placeholder="MM">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Khutbah Starts Time (HH:MM - 24h format)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="input-khutbah-h" class="form-control" min="0" max="23"
                                placeholder="HH">
                            <input type="number" id="input-khutbah-m" class="form-control" min="0" max="59"
                                placeholder="MM">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Jummah Jamaat Time (HH:MM - 24h format)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="input-jamaat-h" class="form-control" min="0" max="23"
                                placeholder="HH">
                            <input type="number" id="input-jamaat-m" class="form-control" min="0" max="59"
                                placeholder="MM">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Countdown Start Time (Friday HH:MM)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="input-start-h" class="form-control" min="0" max="23"
                                placeholder="HH">
                            <input type="number" id="input-start-m" class="form-control" min="0" max="59"
                                placeholder="MM">
                        </div>
                    </div>

                    <div class="form-group" style="background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,0.08);">
                        <label><i class="fas fa-hourglass-half" style="color:var(--gold-primary);"></i> Countdown Before Jamat <span style="color:var(--text-muted); font-size:0.8rem; font-weight:400;"> &mdash; minutes before Jamaat to show countdown overlay</span></label>
                        <input type="number" id="input-countdown-mins" class="form-control" min="1" max="60" placeholder="15" style="max-width:120px; margin-top:8px;">
                    </div>

                    <h3 style="margin:20px 0 5px; color:var(--gold-light); border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                        Daily Prayers &mdash; Jamat Times (4-Week Schedule)</h3>
                    <p style="color:var(--text-muted); font-size:0.82rem; margin:0 0 12px;">
                        Set different jamat times per week of the month.<br>
                        <span style="color:#4ade80;">&#9679;</span> marks the current week. The display automatically uses the matching week.
                    </p>

                    <div class="week-tabs">
                        <button class="week-tab-btn active" onclick="switchWeekTab(0)">Week 1<small>1st &ndash; 7th</small></button>
                        <button class="week-tab-btn" onclick="switchWeekTab(1)">Week 2<small>8th &ndash; 14th</small></button>
                        <button class="week-tab-btn" onclick="switchWeekTab(2)">Week 3<small>15th &ndash; 21st</small></button>
                        <button class="week-tab-btn" onclick="switchWeekTab(3)">Week 4<small>22nd &ndash; 31st</small></button>
                    </div>

                    <!-- WEEK 1 -->
                    <div id="week-tab-0" class="week-content active">
                        <div class="form-group"><label>Fajr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w0-fajr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w0-fajr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Dhuhr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w0-dhuhr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w0-dhuhr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Asr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w0-asr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w0-asr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Maghrib Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w0-maghrib-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w0-maghrib-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Isha Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w0-isha-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w0-isha-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                    </div>

                    <!-- WEEK 2 -->
                    <div id="week-tab-1" class="week-content">
                        <div class="form-group"><label>Fajr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w1-fajr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w1-fajr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Dhuhr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w1-dhuhr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w1-dhuhr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Asr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w1-asr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w1-asr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Maghrib Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w1-maghrib-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w1-maghrib-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Isha Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w1-isha-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w1-isha-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                    </div>

                    <!-- WEEK 3 -->
                    <div id="week-tab-2" class="week-content">
                        <div class="form-group"><label>Fajr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w2-fajr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w2-fajr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Dhuhr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w2-dhuhr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w2-dhuhr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Asr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w2-asr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w2-asr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Maghrib Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w2-maghrib-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w2-maghrib-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Isha Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w2-isha-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w2-isha-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                    </div>

                    <!-- WEEK 4 -->
                    <div id="week-tab-3" class="week-content">
                        <div class="form-group"><label>Fajr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w3-fajr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w3-fajr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Dhuhr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w3-dhuhr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w3-dhuhr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Asr Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w3-asr-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w3-asr-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Maghrib Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w3-maghrib-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w3-maghrib-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                        <div class="form-group"><label>Isha Jamat</label><div style="display:flex;gap:10px;"><input type="number" id="w3-isha-h" class="form-control" min="0" max="23" placeholder="HH"><input type="number" id="w3-isha-m" class="form-control" min="0" max="59" placeholder="MM"></div></div>
                    </div>

                </div>

                <!-- 2. SLIDES -->
                <div id="tab-slides" class="tab-content">

                    <div class="form-group"
                        style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; border:1px dashed var(--gold-primary); margin-bottom: 20px;">
                        <label style="color:var(--gold-primary); margin-bottom: 10px;"><i
                                class="fas fa-cloud-upload-alt"></i> Upload New Slide (Image File)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="file" id="input-slide-file" class="form-control" accept="image/*">
                            <button class="btn btn-primary" id="btn-upload" onclick="uploadSlideFile()">Upload</button>
                        </div>
                        <small style="color: #aaa; margin-top:5px; display:block;">Supported: JPG, PNG, GIF</small>
                    </div>

                    <div
                        style="text-align:center; margin:15px 0; color:var(--text-muted); position:relative; margin-bottom: 20px;">
                        <span
                            style="background: rgb(20,20,20); padding:0 10px; position:relative; z-index:1; font-size: 0.85rem;">OR
                            ADD VIA LINK</span>
                        <div
                            style="position:absolute; top:50%; left:0; width:100%; height:1px; background:rgba(255,255,255,0.1); z-index:0;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Add Slide via URL</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="input-slide-url" class="form-control"
                                placeholder="https://example.com/image.jpg">
                            <button class="btn btn-primary" onclick="addNewSlide()">Add</button>
                        </div>
                    </div>

                    <label style="margin-top:20px;">Active Slides</label>
                    <ul id="admin-slide-list" class="slide-list">
                        <!-- Populated by JS -->
                    </ul>
                </div>

                <!-- 3. APPEARANCE -->
                <div id="tab-appearance" class="tab-content">
                    <label>Color Scheme</label>
                    <div class="theme-grid">
                        <div class="theme-card" data-theme="gold" onclick="selectTheme('gold')">
                            <div class="theme-preview">
                                <div class="theme-preview-bar"
                                    style="background: linear-gradient(135deg, #0f1316 0%, #1a1a1a 30%, #d4af37 50%, #f3e5ab 70%, #aa8c2c 100%);">
                                </div>
                            </div>
                            <div class="theme-name">Gold Classic</div>
                        </div>
                        <div class="theme-card" data-theme="emerald" onclick="selectTheme('emerald')">
                            <div class="theme-preview">
                                <div class="theme-preview-bar"
                                    style="background: linear-gradient(135deg, #0a1612 0%, #0d1f19 30%, #10b981 50%, #6ee7b7 70%, #047857 100%);">
                                </div>
                            </div>
                            <div class="theme-name">Emerald Oasis</div>
                        </div>
                        <div class="theme-card" data-theme="royal" onclick="selectTheme('royal')">
                            <div class="theme-preview">
                                <div class="theme-preview-bar"
                                    style="background: linear-gradient(135deg, #0c0f1a 0%, #131830 30%, #3b82f6 50%, #93c5fd 70%, #1d4ed8 100%);">
                                </div>
                            </div>
                            <div class="theme-name">Royal Night</div>
                        </div>
                        <div class="theme-card" data-theme="rose" onclick="selectTheme('rose')">
                            <div class="theme-preview">
                                <div class="theme-preview-bar"
                                    style="background: linear-gradient(135deg, #16100f 0%, #251515 30%, #f43f5e 50%, #fda4af 70%, #be123c 100%);">
                                </div>
                            </div>
                            <div class="theme-name">Rose Dawn</div>
                        </div>
                        <!-- Custom Color Picker -->
                        <div class="theme-card custom-color-card" data-theme="custom" onclick="selectTheme('custom')">
                            <div class="theme-preview" id="custom-theme-preview">
                                <div class="theme-preview-bar" id="custom-preview-bar"
                                    style="background: linear-gradient(135deg, #111 0%, #1a1a2e 30%, #7c3aed 50%, #c4b5fd 70%, #5b21b6 100%);">
                                </div>
                            </div>
                            <div class="theme-name">Custom Color</div>
                        </div>
                    </div>

                    <!-- Custom Color Picker Row (shown when Custom selected) -->
                    <div class="custom-color-picker-row" id="custom-color-row">
                        <input type="color" id="input-custom-color" value="#7c3aed"
                            oninput="onCustomColorChange(this.value)"
                            title="Pick your brand color">
                        <div id="custom-color-swatch" class="color-swatch-preview" style="background:#7c3aed;"></div>
                        <div>
                            <div style="font-size:0.85rem; color:var(--text-white); font-weight:600;">Pick any colour</div>
                            <div style="font-size:0.75rem; color:var(--text-muted); margin-top:2px;">The display will auto-compute a full cohesive theme from your chosen colour.</div>
                        </div>
                    </div>

                    <label style="margin-top: 25px; display: block;">Layout Style</label>
                    <div class="theme-grid">
                        <div class="layout-card" data-layout="classic" onclick="selectLayout('classic')">
                            <div class="layout-preview">
                                <svg viewBox="0 0 100 60" fill="none">
                                    <rect x="2" y="2" width="35" height="56" rx="3" fill="rgba(255,255,255,0.2)"
                                        stroke="var(--gold-primary)" stroke-width="1" />
                                    <rect x="42" y="2" width="56" height="56" rx="3" fill="rgba(255,255,255,0.1)"
                                        stroke="rgba(255,255,255,0.3)" stroke-width="1" />
                                </svg>
                            </div>
                            <div class="theme-name">Classic</div>
                        </div>
                        <div class="layout-card" data-layout="media-focus" onclick="selectLayout('media-focus')">
                            <div class="layout-preview">
                                <svg viewBox="0 0 100 60" fill="none">
                                    <rect x="2" y="2" width="22" height="56" rx="3" fill="rgba(255,255,255,0.2)"
                                        stroke="var(--gold-primary)" stroke-width="1" />
                                    <rect x="28" y="2" width="70" height="56" rx="3" fill="rgba(255,255,255,0.1)"
                                        stroke="rgba(255,255,255,0.3)" stroke-width="1" />
                                </svg>
                            </div>
                            <div class="theme-name">Media Focus</div>
                        </div>
                        <div class="layout-card" data-layout="fullscreen" onclick="selectLayout('fullscreen')">
                            <div class="layout-preview">
                                <svg viewBox="0 0 100 60" fill="none">
                                    <rect x="2" y="2" width="96" height="56" rx="3" fill="rgba(255,255,255,0.1)"
                                        stroke="rgba(255,255,255,0.3)" stroke-width="1" />
                                    <rect x="6" y="30" width="28" height="24" rx="2" fill="rgba(255,255,255,0.3)"
                                        stroke="var(--gold-primary)" stroke-width="1" />
                                </svg>
                            </div>
                            <div class="theme-name">Full Screen</div>
                        </div>
                        <div class="layout-card" data-layout="vertical" onclick="selectLayout('vertical')">
                            <div class="layout-preview">
                                <svg viewBox="0 0 100 60" fill="none">
                                    <rect x="2" y="2" width="96" height="30" rx="3" fill="rgba(255,255,255,0.1)"
                                        stroke="rgba(255,255,255,0.3)" stroke-width="1" />
                                    <rect x="2" y="36" width="96" height="22" rx="3" fill="rgba(255,255,255,0.2)"
                                        stroke="var(--gold-primary)" stroke-width="1" />
                                </svg>
                            </div>
                            <div class="theme-name">Vertical</div>
                        </div>
                    </div>
                </div>

                <!-- 4. API SETTINGS -->
                <div id="tab-api" class="tab-content">
                    <p style="color: var(--gold-primary); margin-bottom: 20px;">
                        <i class="fas fa-satellite-dish"></i> Prayer Times provided by Aladhan API
                    </p>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="api-city" class="form-control" placeholder="London">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="api-country" class="form-control" placeholder="UK">
                    </div>
                    <div class="form-group">
                        <label>Calculation Method</label>
                        <select id="api-method" class="form-control"
                            style="background: rgba(255, 255, 255, 0.05); color: white;">
                            <option value="3">Muslim World League</option>
                            <option value="2">ISNA</option>
                            <option value="5">Egyptian General Authority</option>
                            <option value="4">Umm Al-Qura University, Makkah</option>
                            <option value="1">University of Islamic Sciences, Karachi</option>
                            <option value="12">France (UOIF)</option>
                            <option value="13">Turkey (Diyanet)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Asr Juristic Method</label>
                        <select id="api-school" class="form-control"
                            style="background: rgba(255, 255, 255, 0.05); color: white;">
                            <option value="0">Shafi (Standard)</option>
                            <option value="1">Hanafi</option>
                        </select>
                    </div>

                    <div style="margin-top:25px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div>
                                <div style="font-weight:600; color:var(--text-white);"><i class="fas fa-table" style="color:var(--gold-primary);"></i> Prayer Timetable Preview</div>
                                <div style="font-size:0.78rem; color:var(--text-muted); margin-top:2px;">Begins times from Aladhan for this month &mdash; W1&ndash;W4 shows which week config applies</div>
                            </div>
                            <button class="btn btn-secondary" onclick="loadTimetable()" id="btn-load-timetable" style="padding:8px 14px; font-size:0.82rem; white-space:nowrap;">
                                <i class="fas fa-table"></i> Load
                            </button>
                        </div>
                        <div id="timetable-container" style="display:none;">
                            <div id="timetable-content"></div>
                        </div>
                    </div>
                </div>

                <!-- SAVE BUTTON -->
                <div
                    style="margin-top:30px; text-align:right; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                    <button class="btn btn-primary" id="btn-save" style="width: 200px;" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        // SECURITY NOTE: For production deployment, consider using environment variables
        // or Firebase Hosting with reserved URLs to protect these credentials.
        // See instructions.md for more details on securing your Firebase config.
        const firebaseConfig = {
            apiKey: "AIzaSyCirBPRHp02zVZFUp5F1t42xm0jEmZeiEc",
            authDomain: "mosquedisplay-eab43.firebaseapp.com",
            projectId: "mosquedisplay-eab43",
            storageBucket: "mosquedisplay-eab43.firebasestorage.app",
            messagingSenderId: "542105594974",
            appId: "1:542105594974:web:63b591fa0d3cd697eb98cf"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // --- CONSTANTS ---
        const CONSTANTS = {
            FRIDAY_DAY_INDEX: 5,
            MAX_IMAGE_SIZE_BYTES: 500000,
            IMAGE_QUALITY: 0.6,
            MAX_IMAGE_WIDTH: 800
        };

        const WEEK_DEFAULT = { fajr:{h:6,m:0}, dhuhr:{h:13,m:0}, asr:{h:16,m:30}, maghrib:{h:18,m:0}, isha:{h:20,m:30} };

        const DEFAULT_CONFIG = {
            theme: 'gold',
            layout: 'classic',
            countdownMinutes: 15,
            customColor: '#7c3aed',
            jummah: {
                dayIndex: CONSTANTS.FRIDAY_DAY_INDEX,
                startDisplayHour: 10, startDisplayMinute: 0,
                speechHour: 12, speechMinute: 15,
                khutbahHour: 12, khutbahMinute: 40,
                jamaatHour: 12, jamaatMinute: 45,
                postPrayerEndHour: 15, postPrayerEndMinute: 0
            },
            slides: [],
            prayerConfig: { city: "Nottingham", country: "UK", method: 3, school: 1 },
            weeklyPrayers: [
                JSON.parse(JSON.stringify(WEEK_DEFAULT)),
                JSON.parse(JSON.stringify(WEEK_DEFAULT)),
                JSON.parse(JSON.stringify(WEEK_DEFAULT)),
                JSON.parse(JSON.stringify(WEEK_DEFAULT))
            ]
        };

        let APP_CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('settings-view').style.display = 'block';
                document.getElementById('auth-controls').style.display = 'block';
                document.getElementById('user-email').innerText = user.email;
                loadSettings();
            } else {
                document.getElementById('login-view').style.display = 'block';
                document.getElementById('settings-view').style.display = 'none';
                document.getElementById('auth-controls').style.display = 'none';
            }
        });

        function loginAdmin() {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            const btn = document.querySelector('#login-view .btn-primary');
            const errorP = document.getElementById('login-error');

            if (!email || !pass) {
                errorP.innerText = "Please fill in all fields.";
                errorP.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            errorP.style.display = 'none';

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => {
                    // Success handled by onAuthStateChanged
                })
                .catch((error) => {
                    btn.disabled = false;
                    btn.innerText = 'Login';
                    errorP.innerText = error.message;
                    errorP.style.display = 'block';
                });
        }

        function logout() {
            auth.signOut();
        }

        // --- SETTINGS MANAGEMENT ---
        function loadSettings() {
            db.collection("mosque_data").doc("settings").get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    APP_CONFIG.jummah = data.jummah || DEFAULT_CONFIG.jummah;
                    APP_CONFIG.theme = data.theme || DEFAULT_CONFIG.theme;
                    APP_CONFIG.layout = data.layout || DEFAULT_CONFIG.layout;
                    APP_CONFIG.prayerConfig = data.prayerConfig || DEFAULT_CONFIG.prayerConfig;
                    APP_CONFIG.countdownMinutes = (data.countdownMinutes !== undefined) ? data.countdownMinutes : 15;
                    APP_CONFIG.customColor = data.customColor || '#7c3aed';
                    // Support new weeklyPrayers; migrate from old dailyPrayers if needed
                    if (data.weeklyPrayers && Array.isArray(data.weeklyPrayers) && data.weeklyPrayers.length === 4) {
                        APP_CONFIG.weeklyPrayers = data.weeklyPrayers;
                    } else if (data.dailyPrayers) {
                        APP_CONFIG.weeklyPrayers = [0,1,2,3].map(() => JSON.parse(JSON.stringify(data.dailyPrayers)));
                    } else {
                        APP_CONFIG.weeklyPrayers = JSON.parse(JSON.stringify(DEFAULT_CONFIG.weeklyPrayers));
                    }
                    updateStatsUI();
                }
            });
            ensureBuiltinSlides(); // Seed built-in slides if not yet in Firestore
            db.collection("slides").orderBy("order", "asc").onSnapshot((snapshot) => {
                APP_CONFIG.slides = [];
                snapshot.forEach((doc) => { APP_CONFIG.slides.push({ ...doc.data(), id: doc.id }); });
                renderSlideList();
            });
        }

        function updateStatsUI() {
            // Jummah Timings
            document.getElementById('input-speech-h').value = APP_CONFIG.jummah.speechHour;
            document.getElementById('input-speech-m').value = APP_CONFIG.jummah.speechMinute;
            document.getElementById('input-khutbah-h').value = APP_CONFIG.jummah.khutbahHour;
            document.getElementById('input-khutbah-m').value = APP_CONFIG.jummah.khutbahMinute;
            document.getElementById('input-jamaat-h').value = APP_CONFIG.jummah.jamaatHour;
            document.getElementById('input-jamaat-m').value = APP_CONFIG.jummah.jamaatMinute;
            document.getElementById('input-start-h').value = APP_CONFIG.jummah.startDisplayHour;
            document.getElementById('input-start-m').value = APP_CONFIG.jummah.startDisplayMinute;
            document.getElementById('input-countdown-mins').value = APP_CONFIG.countdownMinutes || 15;

            // Custom colour
            const cc = APP_CONFIG.customColor || '#7c3aed';
            document.getElementById('input-custom-color').value = cc;
            document.getElementById('custom-color-swatch').style.background = cc;
            updateCustomPreviewBar(cc);
            // Show picker row if custom is the active theme
            document.getElementById('custom-color-row').classList.toggle('visible', APP_CONFIG.theme === 'custom');

            // API Settings
            if (APP_CONFIG.prayerConfig) {
                document.getElementById('api-city').value = APP_CONFIG.prayerConfig.city || '';
                document.getElementById('api-country').value = APP_CONFIG.prayerConfig.country || '';
                document.getElementById('api-method').value = APP_CONFIG.prayerConfig.method || 3;
                document.getElementById('api-school').value = APP_CONFIG.prayerConfig.school || 1;
            }

            // Weekly Prayers
            const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            APP_CONFIG.weeklyPrayers.forEach((week, wi) => {
                prayers.forEach(p => {
                    const hEl = document.getElementById(`w${wi}-${p}-h`);
                    const mEl = document.getElementById(`w${wi}-${p}-m`);
                    if (hEl && week[p] !== undefined) hEl.value = week[p].h;
                    if (mEl && week[p] !== undefined) mEl.value = week[p].m;
                });
            });

            // Mark current week tab with green dot
            const day = new Date().getDate();
            const currentWeekIdx = day <= 7 ? 0 : day <= 14 ? 1 : day <= 21 ? 2 : 3;
            document.querySelectorAll('.week-tab-btn').forEach((btn, i) => {
                btn.classList.toggle('current-week', i === currentWeekIdx);
            });

            selectTheme(APP_CONFIG.theme);
            selectLayout(APP_CONFIG.layout);
        }

        function saveSettings() {
            const btn = document.getElementById('btn-save');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            // Jummah timings
            APP_CONFIG.jummah.speechHour = parseInt(document.getElementById('input-speech-h').value) || 0;
            APP_CONFIG.jummah.speechMinute = parseInt(document.getElementById('input-speech-m').value) || 0;
            APP_CONFIG.jummah.khutbahHour = parseInt(document.getElementById('input-khutbah-h').value) || 0;
            APP_CONFIG.jummah.khutbahMinute = parseInt(document.getElementById('input-khutbah-m').value) || 0;
            APP_CONFIG.jummah.jamaatHour = parseInt(document.getElementById('input-jamaat-h').value) || 0;
            APP_CONFIG.jummah.jamaatMinute = parseInt(document.getElementById('input-jamaat-m').value) || 0;
            APP_CONFIG.jummah.startDisplayHour = parseInt(document.getElementById('input-start-h').value) || 0;
            APP_CONFIG.jummah.startDisplayMinute = parseInt(document.getElementById('input-start-m').value) || 0;

            // Countdown minutes
            APP_CONFIG.countdownMinutes = Math.max(1, parseInt(document.getElementById('input-countdown-mins').value) || 15);

            // Custom colour
            APP_CONFIG.customColor = document.getElementById('input-custom-color').value || '#7c3aed';

            // Prayer API Config
            APP_CONFIG.prayerConfig.city = document.getElementById('api-city').value.trim();
            APP_CONFIG.prayerConfig.country = document.getElementById('api-country').value.trim();
            APP_CONFIG.prayerConfig.method = parseInt(document.getElementById('api-method').value);
            APP_CONFIG.prayerConfig.school = parseInt(document.getElementById('api-school').value);

            // Weekly Prayers (4 weeks)
            const prayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            APP_CONFIG.weeklyPrayers = [0, 1, 2, 3].map(wi => {
                const week = {};
                prayers.forEach(p => {
                    week[p] = {
                        h: parseInt(document.getElementById(`w${wi}-${p}-h`).value) || 0,
                        m: parseInt(document.getElementById(`w${wi}-${p}-m`).value) || 0
                    };
                });
                return week;
            });

            db.collection("mosque_data").doc("settings").set({
                jummah: APP_CONFIG.jummah,
                theme: APP_CONFIG.theme,
                layout: APP_CONFIG.layout,
                prayerConfig: APP_CONFIG.prayerConfig,
                countdownMinutes: APP_CONFIG.countdownMinutes,
                customColor: APP_CONFIG.customColor,
                weeklyPrayers: APP_CONFIG.weeklyPrayers
            }, { merge: true })
                .then(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
                })
                .catch((error) => {
                    alert("Error saving: " + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        // --- SLIDE LOGIC ---
        function escapeHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function renderSlideList() {
            const list = document.getElementById('admin-slide-list');
            list.innerHTML = '';
            APP_CONFIG.slides.forEach((slide, index) => {
                const li = document.createElement('li');
                li.className = `slide-item ${!slide.visible ? 'hidden-slide' : ''}`;

                if (slide.builtin) {
                    const icon  = slide.subtype === 'silent' ? 'fa-mobile-screen-button' : 'fa-hand-holding-heart';
                    const color = slide.subtype === 'silent' ? '#ff6b6b' : 'var(--gold-light)';
                    const bg    = slide.subtype === 'donate'
                        ? 'background:radial-gradient(circle,#203a43,#0f2027);'
                        : 'background:#050505;';
                    li.innerHTML = `
                        <span style="font-family:monospace;color:var(--gold-primary);">${index + 1}</span>
                        <div class="builtin-slide-thumb" style="${bg}">
                            <i class="fas ${icon}" style="color:${color};"></i>
                        </div>
                        <span class="slide-url">${escapeHtml(slide.titleEn || 'Built-in Slide')}
                            <span class="builtin-badge">Built-in</span>
                        </span>
                        <div class="slide-actions">
                            <button class="icon-btn" onclick="openBuiltinEditModal('${slide.id}')" title="Edit Text" style="color:var(--gold-primary);">
                                <i class="fas fa-pencil"></i>
                            </button>
                            <button class="icon-btn" onclick="toggleSlideVisible('${slide.id}', ${!slide.visible})" title="Toggle Visibility">
                                <i class="fas ${slide.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                            </button>
                            <button class="icon-btn" onclick="moveSlideUp(${index})" title="Move Up">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="icon-btn" onclick="moveSlideDown(${index})" title="Move Down">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="icon-btn" onclick="deleteSlide('${slide.id}')" title="Delete" style="color:#ff6b6b">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`;
                } else {
                    li.innerHTML = `
                        <span style="font-family:monospace;color:var(--gold-primary);">${index + 1}</span>
                        <img src="${slide.url}" class="slide-thumb">
                        <span class="slide-url" title="${slide.url}">${slide.url}</span>
                        <div class="slide-actions">
                            <button class="icon-btn" onclick="toggleSlideVisible('${slide.id}', ${!slide.visible})" title="Toggle Visibility">
                                <i class="fas ${slide.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                            </button>
                            <button class="icon-btn" onclick="moveSlideUp(${index})" title="Move Up">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="icon-btn" onclick="moveSlideDown(${index})" title="Move Down">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="icon-btn" onclick="deleteSlide('${slide.id}')" title="Delete" style="color:#ff6b6b">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`;
                }
                list.appendChild(li);
            });
        }

        function addNewSlide() {
            const urlInput = document.getElementById('input-slide-url');
            const url = urlInput.value.trim();
            if (!url) return;

            db.collection("slides").add({
                url: url,
                visible: true,
                order: APP_CONFIG.slides.length
            }).then(() => {
                urlInput.value = '';
            });
        }

        // Upload Logic (Compressed)
        function uploadSlideFile() {
            const fileInput = document.getElementById('input-slide-file');
            const file = fileInput.files[0];
            const btn = document.getElementById('btn-upload');

            if (!file) return;

            btn.disabled = true;
            btn.innerText = "Compressing...";

            // 1. Compress Image
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > CONSTANTS.MAX_IMAGE_WIDTH) {
                        height = Math.round(height * (CONSTANTS.MAX_IMAGE_WIDTH / width));
                        width = CONSTANTS.MAX_IMAGE_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', CONSTANTS.IMAGE_QUALITY);

                    // 2. Upload to Firestore (as Base64 string for simplicity/portability without storage bucket setup issues)
                    // If you have Storage enabled, upload there. For now, we use Data URL to keep it simple as per original code logic.
                    // However, original code implies "Cloud System" so ideally storage, but dataURL works for small lists.

                    btn.innerText = "Uploading...";

                    db.collection("slides").add({
                        url: dataUrl,
                        visible: true,
                        order: APP_CONFIG.slides.length
                    }).then(() => {
                        fileInput.value = '';
                        btn.innerText = "Upload";
                        btn.disabled = false;
                    }).catch(err => {
                        console.error(err);
                        alert("Upload failed. Image might be too large for Firestore document.");
                        btn.innerText = "Upload";
                        btn.disabled = false;
                    });
                }
            }
        }

        function deleteSlide(id) {
            if (confirm("Are you sure you want to delete this slide?")) {
                db.collection("slides").doc(id).delete();
            }
        }

        // --- BUILT-IN SLIDE MANAGEMENT ---
        function ensureBuiltinSlides() {
            db.collection('slides').doc('builtin-silent').get().then(doc => {
                if (!doc.exists) db.collection('slides').doc('builtin-silent').set({
                    builtin: true, subtype: 'silent', visible: true, order: 998,
                    titleEn: 'Mobile Phones', titleUr: '\u0645\u0648\u0628\u0627\u0626\u0644 \u0641\u0648\u0646',
                    bodyEn: 'Please switch your phone to silent mode.',
                    bodyUr: '\u0628\u0631\u0627\u06c1 \u06a9\u0631\u0645 \u0627\u067e\u0646\u0627 \u0641\u0648\u0646 \u062e\u0627\u0645\u0648\u0634 \u0631\u06a9\u06be\u06cc\u06ba'
                });
            }).catch(() => {});
            db.collection('slides').doc('builtin-donate').get().then(doc => {
                if (!doc.exists) db.collection('slides').doc('builtin-donate').set({
                    builtin: true, subtype: 'donate', visible: true, order: 999,
                    titleEn: 'Donate Generously', titleUr: '\u0641\u0631\u0627\u062e\u062f\u0644\u06cc \u0633\u06d2 \u0639\u0637\u06cc\u06c1 \u06a9\u0631\u06cc\u06ba',
                    bodyEn: '"Charity does not decrease wealth"',
                    bodyUr: '\u0635\u062f\u0642\u06c1 \u0645\u0627\u0644 \u06a9\u0648 \u06a9\u0645 \u0646\u06c1\u06cc\u06ba \u06a9\u0631\u062a\u0627'
                });
            }).catch(() => {});
        }

        function openBuiltinEditModal(slideId) {
            const slide = APP_CONFIG.slides.find(s => s.id === slideId);
            if (!slide) return;
            document.getElementById('builtin-edit-id').value = slide.id;
            document.getElementById('builtin-edit-titleEn').value = slide.titleEn || '';
            document.getElementById('builtin-edit-titleUr').value = slide.titleUr || '';
            document.getElementById('builtin-edit-bodyEn').value = slide.bodyEn || '';
            document.getElementById('builtin-edit-bodyUr').value = slide.bodyUr || '';
            document.getElementById('builtin-edit-modal').style.display = 'flex';
        }

        function closeBuiltinEditModal() {
            document.getElementById('builtin-edit-modal').style.display = 'none';
        }

        function saveBuiltinSlide() {
            const id = document.getElementById('builtin-edit-id').value;
            const updates = {
                titleEn: document.getElementById('builtin-edit-titleEn').value.trim(),
                titleUr: document.getElementById('builtin-edit-titleUr').value.trim(),
                bodyEn:  document.getElementById('builtin-edit-bodyEn').value.trim(),
                bodyUr:  document.getElementById('builtin-edit-bodyUr').value.trim(),
            };
            const btn = document.getElementById('builtin-save-btn');
            btn.disabled = true; btn.textContent = 'Saving...';
            db.collection('slides').doc(id).update(updates)
                .then(() => closeBuiltinEditModal())
                .catch(err => alert('Save failed: ' + err.message))
                .finally(() => { btn.disabled = false; btn.textContent = 'Save Changes'; });
        }

        function toggleSlideVisible(id, newState) {
            db.collection("slides").doc(id).update({ visible: newState });
        }

        function moveSlideUp(index) {
            if (index === 0) return;
            swapSlides(index, index - 1);
        }

        function moveSlideDown(index) {
            if (index === APP_CONFIG.slides.length - 1) return;
            swapSlides(index, index + 1);
        }

        function swapSlides(idx1, idx2) {
            const s1 = APP_CONFIG.slides[idx1];
            const s2 = APP_CONFIG.slides[idx2];

            // Batch update for atomicity
            const batch = db.batch();
            const ref1 = db.collection("slides").doc(s1.id);
            const ref2 = db.collection("slides").doc(s2.id);

            // Swap order fields
            // Note: In real app, we should probably update ALL orders to be safe, but swapping works if list is consistent
            batch.update(ref1, { order: idx2 });
            batch.update(ref2, { order: idx1 }); // This assumes order == index, which we try to maintain

            batch.commit().catch(err => console.error(err));
        }

        // --- UI HELPERS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Highlight button
            const buttons = document.querySelectorAll('.tab-btn');
            if (tabName === 'timings') buttons[0].classList.add('active');
            if (tabName === 'slides') buttons[1].classList.add('active');
            if (tabName === 'appearance') buttons[2].classList.add('active');
            if (tabName === 'api') buttons[3].classList.add('active');
        }

        function selectTheme(theme) {
            APP_CONFIG.theme = theme;
            document.querySelectorAll('.theme-card').forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.theme === theme) c.classList.add('selected');
            });
            // Show/hide custom colour picker row
            const row = document.getElementById('custom-color-row');
            if (row) row.classList.toggle('visible', theme === 'custom');
            // Recolour admin UI
            if (theme === 'custom') {
                applyAdminThemeColors(APP_CONFIG.customColor || '#7c3aed');
            } else {
                revertAdminThemeColors();
            }
        }

        // --- CUSTOM COLOUR HELPERS (admin) ---
        function updateCustomPreviewBar(hex) {
            const bar = document.getElementById('custom-preview-bar');
            if (!bar) return;
            const swatch = document.getElementById('custom-color-swatch');
            if (swatch) swatch.style.background = hex;
            // Create a light/dark approx for the gradient preview
            const r = parseInt(hex.slice(1,3),16);
            const g = parseInt(hex.slice(3,5),16);
            const b = parseInt(hex.slice(5,7),16);
            const light = '#' + [r+(255-r)*0.55, g+(255-g)*0.55, b+(255-b)*0.55].map(v=>Math.min(255,Math.round(v)).toString(16).padStart(2,'0')).join('');
            const dark  = '#' + [r*0.62, g*0.62, b*0.62].map(v=>Math.min(255,Math.round(v)).toString(16).padStart(2,'0')).join('');
            const bg    = '#' + [r*0.07+6, g*0.07+6, b*0.07+8].map(v=>Math.min(255,Math.round(v)).toString(16).padStart(2,'0')).join('');
            bar.style.background = `linear-gradient(135deg, ${bg} 0%, #1a1a2e 30%, ${hex} 50%, ${light} 70%, ${dark} 100%)`;
        }

        function onCustomColorChange(hex) {
            APP_CONFIG.customColor = hex;
            updateCustomPreviewBar(hex);
            // Recolour admin UI live
            if (APP_CONFIG.theme === 'custom') {
                applyAdminThemeColors(hex);
            }
        }

        // Apply custom hex colour to the admin UI â€” inject a <style> block so it
        // reliably overrides the :root declaration in the stylesheet.
        function applyAdminThemeColors(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            const toHex = v => Math.min(255, Math.round(v)).toString(16).padStart(2, '0');
            const light  = '#' + [r+(255-r)*0.55, g+(255-g)*0.55, b+(255-b)*0.55].map(toHex).join('');
            const dark   = '#' + [r*0.62, g*0.62, b*0.62].map(toHex).join('');
            const bgTint = '#' + [r*0.09+5, g*0.09+5, b*0.09+7].map(toHex).join('');

            let el = document.getElementById('admin-custom-theme-css');
            if (!el) {
                el = document.createElement('style');
                el.id = 'admin-custom-theme-css';
                document.head.appendChild(el);
            }
            el.textContent = `
                :root {
                    --gold-primary: ${hex} !important;
                    --gold-light:   ${light} !important;
                    --gold-dark:    ${dark} !important;
                }
                body { background: linear-gradient(145deg, ${bgTint} 0%, #080a0c 100%) !important; }
                .admin-container { border-color: ${hex} !important; }
                .admin-header { border-bottom-color: ${hex}44 !important; }
            `;
        }

        // Reset admin UI to original gold defaults
        function revertAdminThemeColors() {
            const el = document.getElementById('admin-custom-theme-css');
            if (el) el.textContent = '';
        }

        function selectLayout(layout) {
            APP_CONFIG.layout = layout;
            document.querySelectorAll('.layout-card').forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.layout === layout) c.classList.add('selected');
            });
        }

        // --- WEEK TAB SWITCHING ---
        function switchWeekTab(idx) {
            document.querySelectorAll('.week-content').forEach((el, i) => el.classList.toggle('active', i === idx));
            document.querySelectorAll('.week-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === idx));
        }

        // --- PRAYER TIMETABLE LOADER ---
        async function loadTimetable() {
            const btn = document.getElementById('btn-load-timetable');
            const container = document.getElementById('timetable-container');
            const content = document.getElementById('timetable-content');
            const city = document.getElementById('api-city').value.trim();
            const country = document.getElementById('api-country').value.trim();
            const method = document.getElementById('api-method').value;
            const school = document.getElementById('api-school').value;

            if (!city || !country) { alert('Please enter City and Country first.'); return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            content.innerHTML = '';
            container.style.display = 'block';

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const todayDate = today.getDate();

            try {
                const url = `https://api.aladhan.com/v1/calendarByCity/${year}/${month}?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=${method}&school=${school}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.code !== 200 || !data.data) {
                    content.innerHTML = '<p style="color:#ff6b6b; padding:10px 0;"><i class="fas fa-exclamation-triangle"></i> Failed to load. Check city/country settings.</p>';
                    return;
                }

                const fmt = s => s.split(' ')[0];
                let html = '<div class="timetable-wrap"><table class="timetable"><thead><tr>';
                html += '<th>Date</th><th>Fajr</th><th>Sunrise</th><th>Dhuhr</th><th>Asr</th><th>Maghrib</th><th>Isha</th><th>Week</th>';
                html += '</tr></thead><tbody>';

                data.data.forEach(d => {
                    const t = d.timings;
                    const dayNum = parseInt(d.date.gregorian.day, 10);
                    const weekIdx = dayNum <= 7 ? 1 : dayNum <= 14 ? 2 : dayNum <= 21 ? 3 : 4;
                    const isToday = dayNum === todayDate;
                    html += `<tr${isToday ? ' class="today-row"' : ''}>`;
                    html += `<td>${d.date.readable}${isToday ? ' <strong>(Today)</strong>' : ''}</td>`;
                    html += `<td>${fmt(t.Fajr)}</td><td>${fmt(t.Sunrise)}</td><td>${fmt(t.Dhuhr)}</td>`;
                    html += `<td>${fmt(t.Asr)}</td><td>${fmt(t.Maghrib)}</td><td>${fmt(t.Isha)}</td>`;
                    html += `<td><span class="week-badge">W${weekIdx}</span></td></tr>`;
                });

                html += '</tbody></table></div>';
                content.innerHTML = html;
            } catch (e) {
                content.innerHTML = `<p style="color:#ff6b6b; padding:10px 0;">Error: ${e.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Refresh';
            }
        }

    </script>
</body>

<!-- BUILT-IN SLIDE EDIT MODAL -->
<div id="builtin-edit-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.78);z-index:500;align-items:center;justify-content:center;">
    <div style="background:#131518;border:1px solid var(--gold-primary);border-radius:16px;padding:30px;width:500px;max-width:96vw;box-shadow:0 24px 70px rgba(0,0,0,0.85);">
        <h3 style="color:var(--gold-primary);margin:0 0 22px;font-size:1.05rem;font-family:var(--font-main);">
            <i class="fas fa-pencil" style="margin-right:8px;"></i>Edit Built-in Slide
        </h3>
        <input type="hidden" id="builtin-edit-id">
        <div style="display:flex;flex-direction:column;gap:14px;">
            <div>
                <label style="font-size:0.82rem;color:var(--text-muted);display:block;margin-bottom:5px;">Title (English)</label>
                <input type="text" id="builtin-edit-titleEn" style="width:100%;box-sizing:border-box;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;color:#fff;font-family:var(--font-main);font-size:0.95rem;" placeholder="e.g. Mobile Phones">
            </div>
            <div>
                <label style="font-size:0.82rem;color:var(--text-muted);display:block;margin-bottom:5px;">Title (Urdu) Ø§Ø±Ø¯Ùˆ Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="builtin-edit-titleUr" dir="rtl" style="width:100%;box-sizing:border-box;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;color:#fff;font-family:var(--font-arabic);font-size:1rem;text-align:right;" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙˆØ¨Ø§Ø¦Ù„ ÙÙˆÙ†">
            </div>
            <div>
                <label style="font-size:0.82rem;color:var(--text-muted);display:block;margin-bottom:5px;">Body Text (English)</label>
                <input type="text" id="builtin-edit-bodyEn" style="width:100%;box-sizing:border-box;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;color:#fff;font-family:var(--font-main);font-size:0.95rem;" placeholder="e.g. Please switch your phone to silent mode.">
            </div>
            <div>
                <label style="font-size:0.82rem;color:var(--text-muted);display:block;margin-bottom:5px;">Body Text (Urdu) Ø§Ø±Ø¯Ùˆ Ù…ØªÙ†</label>
                <input type="text" id="builtin-edit-bodyUr" dir="rtl" style="width:100%;box-sizing:border-box;padding:10px 12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;color:#fff;font-family:var(--font-arabic);font-size:1rem;text-align:right;" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ù¾Ù†Ø§ ÙÙˆÙ† Ø®Ø§Ù…ÙˆØ´ Ø±Ú©Ú¾ÛŒÚº">
            </div>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:26px;">
            <button onclick="closeBuiltinEditModal()" style="padding:10px 22px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.07);color:#fff;cursor:pointer;font-size:0.9rem;">Cancel</button>
            <button id="builtin-save-btn" onclick="saveBuiltinSlide()" style="padding:10px 26px;border-radius:8px;border:none;background:var(--gold-primary);color:#000;cursor:pointer;font-weight:700;font-size:0.9rem;">Save Changes</button>
        </div>
    </div>
</div>

</html>
